# Backend Mongo Auth Runbook

## Scope

This runbook covers production auth behavior after backend migration from in-memory storage to MongoDB (`users`, `topics`, `audit_log`).

## Expected behavior

1. `POST /auth/login` validates credentials against `users` collection.
2. Successful login returns `200` and sets session cookie.
3. Failed credentials return `401 INVALID_CREDENTIALS`.

## Common failures

### 1) `MongoParseError: Password contains unescaped characters`

Cause:
- Mongo URI in SSM uses raw password with reserved URL characters.

Fix:
1. URL-encode password:
```bash
node -e 'console.log(encodeURIComponent(process.argv[1]))' 'YOUR_PASSWORD'
```
2. Build URI:
```text
mongodb+srv://<USER>:<ENCODED_PASSWORD>@<CLUSTER>/<DB>?retryWrites=true&w=majority
```
3. Update SSM and redeploy infrastructure.

### 2) Login returns `401` but Mongo is reachable

Cause:
- Admin user missing in `users`, or password hash format mismatch.

Required hash format:
- `salt:hex` generated by Node `scrypt` (not bcrypt).

## Bootstrap admin user

1. Generate hash:
```bash
HASH=$(node -e 'const {randomBytes,scryptSync}=require("node:crypto"); const p=process.argv[1]; const s=randomBytes(16).toString("hex"); const h=scryptSync(p,s,64,{N:16384,r:8,p:1}).toString("hex"); process.stdout.write(s+":"+h)' 'Admin123!ChangeMe')
echo "$HASH"
```

2. Upsert admin in Mongo (`mongosh`):
```javascript
use lit
db.users.updateOne(
  { emailLower: "admin@example.com" },
  {
    $set: {
      name: "System Admin",
      email: "admin@example.com",
      emailLower: "admin@example.com",
      role: "admin",
      passwordHash: "<PASTE_HASH_HERE>",
      selectedTopicId: null,
      failedAttempts: 0,
      lockedUntilMs: null
    }
  },
  { upsert: true }
)
```

3. Validate:
```javascript
db.users.find(
  { emailLower: "admin@example.com" },
  { email: 1, role: 1, failedAttempts: 1, lockedUntilMs: 1 }
)
```

## Quick API checks

```bash
API="https://58r8t1adkk.execute-api.eu-central-1.amazonaws.com"

curl -i "$API/health"

curl -i -X POST "$API/auth/login" \
  -H "content-type: application/json" \
  --data '{"email":"admin@example.com","password":"Admin123!ChangeMe"}'
```

## Notes

- Backend now requires `MONGODB_URI` at runtime.
- Terraform packaging must include backend dependencies (`node_modules`) for Lambda.
